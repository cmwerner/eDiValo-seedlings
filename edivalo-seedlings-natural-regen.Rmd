---
title: "eDiValo Seedlings Natural Regeneration"
output:
  word_document: default
  html_document: default
---

## Setup and data structuring
Loads libraries, sets up custom theme for ggplot, and reads in data (code not printed)
```{r setup2, include=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

#library(plyr) # data structuring
library(tidyverse) # data structuring
library(ggplot2) # plotting
library(ggthemes) # plotting
library(lme4) # basic models
library(lmerTest) # p-values on basic models
library(gtsummary) # pretty tables
library(glmmTMB) # glmm with zero-inflation
library(bbmle) # model comparison tables
library(broom.mixed)
source('edivalo-seedlings-traits.R', local=TRUE) # script with the trait data
source('edivalo-seedlings-environmental.R', local = TRUE) # script with env data

# theme for plotting
theme_cw <- function () { 
  theme_bw(base_size=12) %+replace% 
    theme(
      panel.background = element_blank(), 
      plot.background = element_blank(), 
      axis.ticks = element_line(colour = "grey70", size = rel(0.5)),
      panel.grid.minor = element_blank(), 
      panel.grid.major.x = element_blank(),
      legend.background = element_blank(), 
      legend.key = element_blank(),
      strip.background = element_blank(), 
      strip.text=element_text(size=12),
      axis.text=element_text(size=12),
      complete = TRUE
    )
}

nat.seedlings.10 <- read.csv("data/natural_regen_2019_10.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.03 <- read.csv("data/natural_regen_2020_03.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.05 <- read.csv("data/natural_regen_2020_05.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.06 <- read.csv("data/natural_regen_2020_06.csv", 
                             stringsAsFactors = FALSE)


# Want to combine these together
# remove . and spaces
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.05) <- gsub("[^a-z]","", names(nat.seedlings.05))
names(nat.seedlings.06) <- gsub("[^a-z]","", names(nat.seedlings.06))

# small cleaning issues
nat.seedlings.10$subplot <- ifelse(nat.seedlings.10$subplot==1, "O", "I")
nat.seedlings.03$falvul <- as.integer(substr(nat.seedlings.03$falvul, 1, 1))
nat.seedlings.05 <- nat.seedlings.05[,1:43] # removing blank columsn at the end

# add in year_month time point
nat.seedlings.10$month <- '2019_10'
nat.seedlings.03$month <- '2020_03'
nat.seedlings.05$month <- '2020_05'
nat.seedlings.06$month <- '2020_06'

nat.seedlings.a <- full_join(nat.seedlings.10, nat.seedlings.03)
nat.seedlings.b <- full_join(nat.seedlings.05, nat.seedlings.06)
nat.seedlings <- full_join(nat.seedlings.a, nat.seedlings.b)
nat.seedlings <- nat.seedlings %>% select(month, everything()) # move month to the front

# total observations of each
seedling.sums <- colSums(nat.seedlings[7:47], na.rm=TRUE)


#View(nat.seedlings)
nat.seedlings[is.na(nat.seedlings)] <- 0

# adding separate columns for exclosure, light, and fertilization treatments
nat.seedlings$grazing <- 'sheep'
nat.seedlings$grazing[grep('E', nat.seedlings$treat)] <- 'exclosure'
nat.seedlings$nutrient <- 'unfertilized'
nat.seedlings$nutrient[grep('F', nat.seedlings$treat)] <- 'fertilized'
nat.seedlings$light <- 'control'
nat.seedlings$light[grep('L', nat.seedlings$treat)] <- 'lamps'
nat.seedlings$block <- as.integer((nat.seedlings$plotid - 1)/8) + 1

# column names other than species
non.species.columns <-c('plotid','treat','block','climate','subplot',
                        'grazing','nutrient','light',
                         'month', 'date') 

# all species column names
species.columns <- names(nat.seedlings)[!(names(nat.seedlings) %in% non.species.columns)] 

# long format of data
# also grouping the subplots together here
nat.seedlings.long <- nat.seedlings %>% 
  pivot_longer(cols = species.columns, 
               names_to = 'species', values_to = 'count') %>%
  group_by(plotid, treat, block, climate, grazing, nutrient, light, species, month) %>%
  dplyr::summarise(
    count = sum(count)
  )
#View(nat.seedlings.long)

# summary of total seedling count and species richness in each plot
# split by month
nat.seedlings.plot.sum <- nat.seedlings.long %>% 
  group_by(plotid, treat, block, climate, grazing, nutrient, light, month) %>%
  dplyr::summarise(
    total = sum(count),
        richness = sum(count > 0)
  )

nat.seedlings.plot.sum$block <- as_factor(nat.seedlings.plot.sum$block)
nat.seedlings.plot.sum$plotid <- as_factor(nat.seedlings.plot.sum$plotid)
nat.seedlings.plot.sum$month <- as_factor(nat.seedlings.plot.sum$month)

nat.seedlings.plot.sum.2 <- filter(nat.seedlings.plot.sum, 
                                   month %in% c('2019_10','2020_03','2020_05'))
```

For summary richness and cout analyses, need to make sure block and plotid are being treated as factors
## Total seedlings count
Summary for plotting total and richness (code not printed)
```{r summary-plot, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# summarize by month and treatments for plotting
nat.seedlings.summary <- nat.seedlings.plot.sum.2 %>% 
  group_by(grazing, nutrient, light, month) %>%
  dplyr::summarise(
    n = length(total),
        total.mean = mean(total),
        total.se = sd(total)/sqrt(n),
        rich.mean = mean(richness),
        rich.se = sd(richness)/sqrt(n)
  )

```

Summary for analyzing total and richness (code not printed)
```{r summary-analysis, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding
# splitting data into just fall or just spring for modeling
nat.seedlings.fall <- nat.seedlings.plot.sum %>% filter(month == '2019_10')
nat.seedlings.spring <- nat.seedlings.plot.sum %>% filter(month == '2020_03')
nat.seedlings.late <- nat.seedlings.plot.sum %>% filter(month == '2020_05')

# combined fall and spring together
nat.seedlings.long.fallspring <- nat.seedlings.long %>%
  filter(month %in% c('2019_10', '2020_03'))

nat.seedlings.plot.both <- nat.seedlings.long.fallspring %>% 
  group_by(plotid, treat, block, climate, grazing, nutrient, light) %>%
  dplyr::summarise(
    total = sum(count),
        richness = sum(count > 0)
  )

nat.seedlings.plot.both$block <- as_factor(nat.seedlings.plot.both$block)
nat.seedlings.plot.both$plotid <- as_factor(nat.seedlings.plot.both$plotid)
```


### Total seedling count plot
```{r summary-plot-total, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding}
ggplot(nat.seedlings.summary, aes(x=nutrient, y=total.mean, 
                                  ymin=total.mean-total.se,
                                  ymax=total.mean+total.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Total seedling count') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

#ggsave(filename = 'nat_regen_total_time.pdf', width=6, height=5, units='in')
```

### Total seedling analysis

#### With time
```{r total-seedling-time, echo=FALSE, warning=FALSE, message=FALSE}
model.total <- nat.seedlings.plot.sum %>%
  lmer(total ~ grazing + nutrient + light + month +
         grazing:nutrient + grazing:light + grazing:month +
         nutrient:light + nutrient:month + light:month +
         grazing:nutrient:light + 
         (1|block:plotid),.)
tbl_regression(model.total, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```


Looking at October and March time points as 1. separate models or 2. a combined sum. I think we can make the argument that if we do it this way we won't need time series analyses since we expect Oct seedlings to have died or grown by March, mostly not resampling the same individuals. But there are other approaches to this that use the time series angle.

#### Fall only
```{r tot-seedling-fall, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# want to use block:plot for random effect, but have the error
# number of levels of each grouping factor must be < number of observations
# would need a meta-plot that is the grazing x fert treatment instead
model.total.fall <- nat.seedlings.fall %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.fall, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Spring only
```{r tot-seedling-spring, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.total.spring <- nat.seedlings.spring %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.spring, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Both combined
```{r tot-seedling-both, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.total.both <- nat.seedlings.plot.both %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.both, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))

```


## Seedling richness
### Seedling richness plot
```{r summary-plot-richness, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding}
ggplot(nat.seedlings.summary, aes(x=nutrient, y=rich.mean, 
                                  ymin=rich.mean-rich.se, 
                                  ymax=rich.mean+rich.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Seedling richness') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))
#ggsave(filename = 'nat_regen_richness_time.pdf', width=6, height=5, units='in')
```

### Seedling richness analysis
#### With time
```{r rich-seedling-time, echo=FALSE, warning=FALSE, message=FALSE}
model.richness <- nat.seedlings.plot.sum %>%
  lmer(richness ~ grazing + nutrient + light + month +
         grazing:nutrient + grazing:light + grazing:month +
         nutrient:light + nutrient:month + light:month +
         grazing:nutrient:light + 
         (1|block:plotid),.)
tbl_regression(model.richness, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Fall only
```{r rich-seedling-fall, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# want to use block:plot for random effect, but have the error
# number of levels of each grouping factor must be < number of observations
# would need a meta-plot that is the grazing x fert treatment instead
model.richness.fall <- nat.seedlings.fall %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.fall, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Spring only
```{r rich-seedling-spring, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.spring <- nat.seedlings.spring %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.spring, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Both combined
```{r rich-seedling-both, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.both <- nat.seedlings.plot.both %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.both, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))

```

#### April/May 
```{r rich-seedling-late, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.late <- nat.seedlings.late %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.late, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

## Seedling Traits

For the trait analyses we will look at the data sliced a slightly different way--the max number of seedlings per species across the time points (peak emergence for each species)
```{r trait-biomass, echo=FALSE, warning=FALSE, message=FALSE}

# max across time points (seems to be working, still want to triple-check it)
nat.seedlings.max <- nat.seedlings.long %>%
  group_by(plotid, treat, block, grazing, nutrient, light, species, climate) %>%
  dplyr::summarise(
    count.max = max(count)
  )

# combine with trait data, 
# filter down to the species for which we have trait data
nat.seedlings.traits <- nat.seedlings.max %>% 
  left_join(species.size.7, by = 'species') %>% 
  filter(!is.na(bm.tot))
nat.seedlings.traits$block <- as.factor(nat.seedlings.traits$block)
nat.seedlings.traits$plotid <- as.factor(nat.seedlings.traits$plotid)

# summary by species for ggplot
nat.seedlings.traits.sum <- nat.seedlings.traits %>%
  group_by(grazing, nutrient, light, species) %>%
  dplyr::summarise(
    abundance = mean(count.max),
    abundance.se = sd(count.max)/sqrt(10),
    bm.tot = mean(bm.tot), 
    rt.sh.bm = mean(rt.sh.bm),
    len.sh = mean(len.sh),
    sla = mean(sla.2),
    c.n = mean(c.n.ratio)
    # traits should be the same as their values, double-check
  )


# simpler summary for ggplot (without nitrogen)
nat.seedlings.traits.sum.2 <- nat.seedlings.traits %>%
  group_by(grazing, light, species) %>%
  dplyr::summarise(
    abundance = mean(count.max),
    abundance.se = sd(count.max)/sqrt(20),
    bm.tot = mean(bm.tot), 
    rt.sh.bm = mean(rt.sh.bm),
    len.sh = mean(len.sh),
    sla = mean(sla.2),
    c.n = mean(c.n.ratio)
    # traits should be the same as their values, double-check
  )

# simulated dataset for counter-factual plots
new.data <- nat.seedlings.traits
new.data$species <- "new"
new.data$block <- "new"
new.data$plotid <- "new"


```

### Species traits abundance models
The data is overdispersed and/or zero-inflated. We want to try to put together a model format that seems reasonable before adding in the trait data. Using the 'glmmTMB' package, which is detailed in "glmmTMB Balances Speed and Flexibility Among Packages for Zero-inflated Generalized Linear Mixed Modeling" by Brooks et al 2017, and the AICtab() function in the 'bblme' package for convenient AIC comparisons of different models. 

Options for model distrubtions are: Poisson, and negative binomial, as well as zero-inflated or hurdle models. Negative binomial is better than Poisson or the zero-inflated options (code included but not run)

```{r basic-models, echo=FALSE, warning=FALSE, message=FALSE}

# # poisson
#  m.p.basic <- glmmTMB(count.max ~ grazing + nutrient + light + (1|species) +
#                     (1|block:plotid), 
#                   nat.seedlings.max, family = poisson)
#  
#  m.p.full <- glmmTMB(count.max ~ grazing * nutrient * light + (1|species) +
#                     (1|block:plotid), 
#                   nat.seedlings.max, family = poisson)
#  
#  m.p.specific <- glmmTMB(count.max ~ grazing * nutrient + light + (1|species) +
#                     (1|block:plotid), 
#                   nat.seedlings.max, family = poisson)
# 
# # negative binomial
# 
#  m.nb.basic <- glmmTMB(count.max ~ grazing + nutrient + light + (1|species) +
#                     (1|block:plotid), 
#                   nat.seedlings.max, family = nbinom2)
#  
#  m.nb.full <- glmmTMB(count.max ~ grazing * nutrient * light + (1|species) +
#                     (1|block:plotid), 
#                   nat.seedlings.max, family = nbinom2)
# 
# m.nb.specific <- glmmTMB(count.max ~ grazing * nutrient + light + (1|species) +
#                    (1|block:plotid), 
#                  nat.seedlings.max, family = nbinom2)
# 
# # zi poisson
# m.pois.zi.specific <- glmmTMB(count.max ~ grazing * nutrient + light +
#                    (1|block:plotid), zi = ~ grazing + (1|species), 
#                  nat.seedlings.max, family = poisson)
# 
# # zi neg binomial
# m.nb.zi.specific <- glmmTMB(count.max ~ grazing * nutrient + light +
#                    (1|block:plotid), zi = ~ grazing + (1|species), 
#                  nat.seedlings.max, family = nbinom2)
# summary(m.nb.zi.specific)
# 
# 
# AICtab(m.nb.specific, m.pois.zi.specific, m.nb.zi.specific)

```

Moving forward to the trait analyses. Running preliminary analyses for now with each trait separately. Could also consider models that include multiple traits, especially since most of the traits aren't strongly correlated with each other. 

For each trait, we are comparing five models:
0 -- null model without the traits, with a random variable for species
1 -- just the trait, no random variable for species 
2 -- trait and random variable for species
full -- all 2-way, 3-way, and 4-way interactions
specific -- 3-way interactions for grazing x light x trait and grazing x light x nutrients, which are the ones that are significant in some of the models. 

Results below each model show the summary for the specific model, an AIC table comparing these options, and the under- or over-dispersion coefficient. 

### Total biomass 
Preliminary plot of raw data
```{r trait-biomass-plot, echo=FALSE, warning=FALSE, message=FALSE}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = bm.tot, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Total biomass') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```


Preliminary analysis of total biomass trait using a negative binomial distribution. 
```{r trait-biomass-analysis, echo=FALSE, warning=FALSE, message=FALSE}

m.biomass.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.biomass.1 <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.2 <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)


m.biomass.full <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                            grazing*nutrient*light*bm.tot +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.specific <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                            light*grazing*bm.tot + light*grazing*nutrient + 
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)
summary(m.biomass.specific)

AICtab(m.biomass.0, m.biomass.1, m.biomass.2, m.biomass.full, m.biomass.specific)

E2 <- resid(m.biomass.specific, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.biomass.specific)) 
sum(E2^2) / (N - p) # somewhat overdispersed
```

Counterfactual plots (not including nutrients, since they don't interact with the traits). Using re.form = NA to specific population-level predictions (setting all random effects to zero)
```{r trait-biomass-plots2, echo=FALSE, warning=FALSE, message=FALSE}


# currently without nitrogen
# can also try adding it back in and doing the prediction more clearly
m.biomass.simple <- glmmTMB(count.max ~ light*grazing*bm.tot + 
                          (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.fit <- predict(m.biomass.simple, new.data, allow.new.levels = TRUE, se.fit = TRUE,
                     re.form = NA, type = 'response')
new.data$biomass.fit <- m.biomass.fit$fit
new.data$biomass.fit.se <- m.biomass.fit$se.fit

ggplot(NULL) + 
  facet_grid(.~grazing) +
  geom_line(data = new.data, size = 1.2, aes(x = bm.tot, y = biomass.fit, color = light)) + 
  geom_ribbon(data = new.data, alpha = 0.3,
              aes(x = bm.tot, y = biomass.fit, 
                  ymin = biomass.fit - biomass.fit.se, ymax = biomass.fit + biomass.fit.se,
                  fill = light)) +
 # geom_point(data = nat.seedlings.traits.sum.2, aes(x = bm.tot, y = abundance, color = light)) + 
  theme_cw() + 
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  scale_fill_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12)) + 
  ylab('Predicted abundance') + 
  xlab('Biomass')
#ggsave('biomass-model.pdf', width = 6, height = 4, units = 'in')


```

### SLA 
Preliminary plot of raw data

```{r trait-sla-plot, echo=FALSE, warning=FALSE, message=FALSE}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = sla, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('SLA') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

Preliminary analysis of SLA
```{r trait-sla-analysis, echo=FALSE, warning=FALSE, message=FALSE}

m.sla.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.sla.1 <- glmmTMB(count.max ~ grazing * nutrient + light + sla.2 +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.sla.2 <- glmmTMB(count.max ~ grazing * nutrient + light + sla.2 +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.sla.full <- glmmTMB(count.max ~ grazing * nutrient + light + sla.2 +
                            grazing*nutrient*light*sla.2 +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.sla.specific <- glmmTMB(count.max ~ grazing * nutrient + light + sla.2 +
                            light*grazing*sla.2 + grazing*nutrient*light +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)
#summary(m.sla.specific)

AICtab(m.sla.0, m.sla.1, m.sla.2, m.sla.full, m.sla.specific)

E2 <- resid(m.sla.specific, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.sla.specific)) 
sum(E2^2) / (N - p) # somewhat overdispersed

# simplified summary of model coefficients
tbl_regression(m.sla.specific, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light',
                                   'grazing:nutrient:light',
                                   'light:sla.2','grazing:sla.2',
                                   'grazing:light:sla.2'))

```

Counterfactual plots (not including nutrients, since they don't interact with the traits). Using re.form = NA to specific population-level predictions (setting all random effects to zero)
```{r trait-SLA-plots2, echo=FALSE, warning=FALSE, message=FALSE}


# currently without nitrogen
# can also try adding it back in and doing the prediction more clearly
m.sla.simple <- glmmTMB(count.max ~ light*grazing*sla.2 + 
                          (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.sla.fit <- predict(m.sla.simple, new.data, allow.new.levels = TRUE, se.fit = TRUE,
                     re.form = NA, type = 'response')
new.data$sla.fit <- m.sla.fit$fit
new.data$sla.fit.se <- m.sla.fit$se.fit

ggplot(NULL) + 
  facet_grid(.~grazing) +
  geom_line(data = new.data, size = 1.2, aes(x = sla.2, y = sla.fit, color = light)) + 
  geom_ribbon(data = new.data, alpha = 0.3,
              aes(x = sla.2, y = sla.fit, 
                  ymin = sla.fit - sla.fit.se, ymax = sla.fit + sla.fit.se,
                  fill = light)) +
#  geom_point(data = nat.seedlings.traits.sum.2, aes(x = sla, y = abundance, color = light)) + 
  theme_cw() + 
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  scale_fill_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12)) + 
  ylab('Predicted abundance') + 
  xlab('SLA')
#ggsave('sla-model-data.pdf', width = 6, height = 4, units = 'in')


```



### C:N 
Preliminary plot of raw data

```{r trait-cn-plot, echo=FALSE, warning=FALSE, message=FALSE}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = c.n, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('C:N') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

Preliminary analysis of C:N. Here there are two specific models, a includes the 3-way interaction between light, grazing, and C:N (which is not significant, but is consistent with the other models above. Also the light x C:N interaction is significant) and b which drops this interaction but then also loses the significance of the light x C:N interaction (but has a better AIC value). Really it's a question of how we want to present/evaluate models--one option is to keep the same "specific" format for all traits, the other is to select it individually for each trait. Also if we are evaluating models based on their predicted significant interactions or on the AIC comparisons. 
```{r trait-cn-analysis, echo=FALSE, warning=FALSE, message=FALSE}

m.cn.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.cn.1 <- glmmTMB(count.max ~ grazing * nutrient + light + c.n.ratio +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.cn.2 <- glmmTMB(count.max ~ grazing * nutrient + light + c.n.ratio +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)


m.cn.full <- glmmTMB(count.max ~ grazing * nutrient + light + c.n.ratio +
                            grazing*nutrient*light*c.n.ratio +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.cn.specific.a <- glmmTMB(count.max ~ grazing * nutrient + light + c.n.ratio +
                            light*grazing*c.n.ratio + grazing*nutrient*light +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.cn.specific.b <- glmmTMB(count.max ~ grazing * nutrient + light + c.n.ratio +
                            light*c.n.ratio + grazing*nutrient*light +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)
summary(m.cn.specific.a)

AICtab(m.cn.0, m.cn.1, m.cn.2, m.cn.full, m.cn.specific.a, m.cn.specific.b)

E2 <- resid(m.cn.specific.a, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.cn.specific.a)) 
sum(E2^2) / (N - p) # somewhat overdispersed
```

Counterfactual plots
```{r trait-CN-plots2, echo=FALSE, warning=FALSE, message=FALSE}

cn.data <- new.data[complete.cases(new.data),] # because we're missing secvar
# currently without nitrogen
# can also try adding it back in and doing the prediction more clearly
m.cn.simple <- glmmTMB(count.max ~ light*grazing*c.n.ratio + 
                          (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.cn.fit <- predict(m.cn.simple, cn.data, allow.new.levels = TRUE, se.fit = TRUE,
                     re.form = NA, type = 'response')
cn.data$cn.fit <- m.cn.fit$fit
cn.data$cn.fit.se <- m.cn.fit$se.fit

ggplot(NULL) + 
  facet_grid(.~grazing) +
  geom_line(data = cn.data, size = 1.2, aes(x = c.n.ratio, y = cn.fit, color = light)) + 
  geom_ribbon(data = cn.data, alpha = 0.3,
              aes(x = c.n.ratio, y = cn.fit, 
                  ymin = cn.fit - cn.fit.se, ymax = cn.fit + cn.fit.se,
                  fill = light)) +
#  geom_point(data = nat.seedlings.traits.sum.2, aes(x = c.n, y = abundance, color = light)) + 
  theme_cw() + 
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  scale_fill_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12)) + 
  ylab('Predicted abundance') + 
  xlab('C:N')
#ggsave('cn-model.pdf', width = 6, height = 4, units = 'in')

# also looking at it without grazing since for C:N that has no interaction
m.cn.simple.2 <- glmmTMB(count.max ~ light*c.n.ratio + 
                          (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.cn.fit.2 <- predict(m.cn.simple.2, cn.data, allow.new.levels = TRUE, se.fit = TRUE,
                     re.form = NA, type = 'response')
cn.data$cn.fit.2 <- m.cn.fit.2$fit
cn.data$cn.fit.se.2 <- m.cn.fit.2$se.fit

ggplot(NULL) + 
 # facet_grid(.~grazing) +
  geom_line(data = cn.data, size = 1.2, aes(x = c.n.ratio, y = cn.fit.2, color = light)) + 
  geom_ribbon(data = cn.data, alpha = 0.3,
              aes(x = c.n.ratio, y = cn.fit.2, 
                  ymin = cn.fit.2 - cn.fit.se.2, ymax = cn.fit.2 + cn.fit.se.2,
                  fill = light)) +
#  geom_point(data = nat.seedlings.traits.sum.2, aes(x = c.n, y = abundance, color = light)) + 
  theme_cw() + 
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  scale_fill_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12)) + 
  ylab('Predicted abundance') + 
  xlab('C:N')
#ggsave('cn-model-2.pdf', width = 4, height = 4, units = 'in')


```

### Root-shoot ratio
Preliminary plot of raw data
```{r trait-rtsh-plot, echo=FALSE, warning=FALSE, message=FALSE}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = rt.sh.bm, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Root:shoot ratio (biomass)') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

```{r trait-rtsh-analysis, echo=FALSE, warning=FALSE, message=FALSE}

m.rt.sh.bm.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.rt.sh.bm.1 <- glmmTMB(count.max ~ grazing * nutrient + light + rt.sh.bm +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.rt.sh.bm.2 <- glmmTMB(count.max ~ grazing * nutrient + light + rt.sh.bm +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.rt.sh.bm.full <- glmmTMB(count.max ~ grazing * nutrient + light + rt.sh.bm +
                            grazing*nutrient*light*rt.sh.bm +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.rt.sh.bm.specific <- glmmTMB(count.max ~ grazing * nutrient + light + rt.sh.bm +
                            light*grazing*rt.sh.bm + grazing*nutrient*light +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)
summary(m.rt.sh.bm.specific)

AICtab(m.rt.sh.bm.0, m.rt.sh.bm.1, m.rt.sh.bm.2, m.rt.sh.bm.full, m.rt.sh.bm.specific)

E2 <- resid(m.rt.sh.bm.specific, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.rt.sh.bm.specific)) 
sum(E2^2) / (N - p) # somewhat overdispersed
```

### Shoot length
Preliminary plot of raw data
```{r trait-length-plot, echo=FALSE, warning=FALSE, message=FALSE}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = len.sh, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Shoot length') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

```{r trait-len-analysis, echo=FALSE, warning=FALSE, message=FALSE}

m.len.sh.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.len.sh.1 <- glmmTMB(count.max ~ grazing * nutrient + light + len.sh +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.len.sh.2 <- glmmTMB(count.max ~ grazing * nutrient + light + len.sh +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.len.sh.full <- glmmTMB(count.max ~ grazing * nutrient + light + len.sh +
                            grazing*nutrient*light*len.sh +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.len.sh.specific <- glmmTMB(count.max ~ grazing * nutrient + light + len.sh +
                            light*grazing*len.sh + grazing*nutrient*light +
                        (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)
summary(m.len.sh.specific)

AICtab(m.len.sh.0, m.len.sh.1, m.len.sh.2, m.len.sh.full, m.len.sh.specific)

E2 <- resid(m.len.sh.specific, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.len.sh.specific)) 
sum(E2^2) / (N - p) # somewhat overdispersed
```

### Trying combining trait models
I tried combining traits into a single model. The models do fine and the results are basically the same, so I think it's fine to stick with separate models for now (because they're simpler and more convenient to present results from) and keep this in case reviewers ask for it. 
```{r traits-multiple, echo=FALSE, warning=FALSE, message=FALSE}

m.all.traits  <- glmmTMB(count.max ~ grazing * nutrient + light +
                           light*grazing*nutrient + 
                           light*grazing*bm.tot + 
                           light*grazing*sla.2 + 
                           light*grazing*c.n.ratio + 
                           (1|species) + (1|block:plotid), 
                         nat.seedlings.traits, family = nbinom2)

m.biomass <- glmmTMB(count.max ~ grazing * nutrient + light + 
                       light*grazing*nutrient + 
                       light*grazing*bm.tot +
                       (1|species) + (1|block:plotid), 
                     nat.seedlings.traits, family = nbinom2)

m.sla <- glmmTMB(count.max ~ grazing * nutrient + light + 
                   light*grazing*nutrient + 
                   light*grazing*sla.2 +
                   (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)


m.cn <- glmmTMB(count.max ~ grazing * nutrient + light + 
                  light*grazing*nutrient + 
                  light*grazing*c.n.ratio +
                  (1|species) + (1|block:plotid), 
                nat.seedlings.traits, family = nbinom2)

m.sla.cn <- glmmTMB(count.max ~ grazing * nutrient + light + 
                      light*grazing*nutrient + 
                      light*grazing*c.n.ratio +
                      light*grazing*sla.2 +
                      (1|species) + (1|block:plotid), 
                    nat.seedlings.traits, family = nbinom2)

AICtab(m.biomass, m.cn, m.sla, m.all.traits, m.sla.cn)
summary(m.all.traits)

```


## Considering light as a continuous variable

Running this with light quantity, doesn't converge. Not sure how long it would be worthwhile to spend trouble-shooting it. Light quality or litter depth do converge both on their own and added to the plot treatments (litter depth and light quantity are strongly correlated at the treatment level)
```{r continuous-light}
plot.env$plotid <- as.factor(plot.env$plotid)
plot.env$block <- as.factor(plot.env$block)


nat.seedlings.traits.env <- nat.seedlings.traits %>%
  left_join(plot.env)

m.sla.litter <- glmmTMB(count.max ~ grazing * nutrient + light + sla.2 +
                            light*grazing*sla.2 + grazing*nutrient*light +
                          litter.depth*sla.2 +
                          (1|species) + (1|block:plotid), 
                 nat.seedlings.traits.env, family = nbinom2)

tbl_regression(m.sla.litter,
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light',
                                   'grazing:nutrient:light',
                                   'light:sla.2','grazing:sla.2',
                                   'grazing:light:sla.2'))

```

