---
title: "eDiValo Seedlings Natural Regeneration"
output:
  word_document: default
  html_document: default
---

## Setup and data structuring
Loads libraries, sets up custom theme for ggplot, and reads in data (code not printed)
```{r setup2, include=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

library(plyr) # data structuring
library(tidyverse) # data structuring
library(ggplot2) # plotting
library(ggthemes) # plotting
library(lme4) # basic models
library(lmerTest) # p-values on basic models
library(gtsummary) # pretty tables
library(glmmTMB) # glmm with zero-inflation
library(bbmle) # model comparison tables
source('edivalo-seedlings-traits.R', local=TRUE) # script with the trait data

# theme for plotting
theme_cw <- function () { 
  theme_bw(base_size=12) %+replace% 
    theme(
      panel.background = element_blank(), 
      plot.background = element_blank(), 
      axis.ticks = element_line(colour = "grey70", size = rel(0.5)),
      panel.grid.minor = element_blank(), 
      panel.grid.major.x = element_blank(),
      legend.background = element_blank(), 
      legend.key = element_blank(),
      strip.background = element_blank(), 
      strip.text=element_text(size=12),
      axis.text=element_text(size=12),
      complete = TRUE
    )
}

nat.seedlings.10 <- read.csv("data/natural_regen_2019_10.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.03 <- read.csv("data/natural_regen_2020_03.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.05 <- read.csv("data/natural_regen_2020_05.csv", 
                             stringsAsFactors = FALSE)
nat.seedlings.06 <- read.csv("data/natural_regen_2020_06.csv", 
                             stringsAsFactors = FALSE)


# Want to combine these together
# remove . and spaces
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.05) <- gsub("[^a-z]","", names(nat.seedlings.05))
names(nat.seedlings.06) <- gsub("[^a-z]","", names(nat.seedlings.06))

# small cleaning issues
nat.seedlings.10$subplot <- ifelse(nat.seedlings.10$subplot==1, "O", "I")
nat.seedlings.03$falvul <- as.integer(substr(nat.seedlings.03$falvul, 1, 1))
nat.seedlings.05 <- nat.seedlings.05[,1:43] # removing blank columsn at the end

# add in year_month time point
nat.seedlings.10$month <- '2019_10'
nat.seedlings.03$month <- '2020_03'
nat.seedlings.05$month <- '2020_05'
nat.seedlings.06$month <- '2020_06'

nat.seedlings.a <- full_join(nat.seedlings.10, nat.seedlings.03)
nat.seedlings.b <- full_join(nat.seedlings.05, nat.seedlings.06)
nat.seedlings <- full_join(nat.seedlings.a, nat.seedlings.b)
nat.seedlings <- nat.seedlings %>% select(month, everything()) # move month to the front

# total observations of each
seedling.sums <- colSums(nat.seedlings[7:47], na.rm=TRUE)


#View(nat.seedlings)
nat.seedlings[is.na(nat.seedlings)] <- 0

# adding separate columns for exclosure, light, and fertilization treatments
nat.seedlings$grazing <- 'sheep'
nat.seedlings$grazing[grep('E', nat.seedlings$treat)] <- 'exclosure'
nat.seedlings$nutrient <- 'unfertilized'
nat.seedlings$nutrient[grep('F', nat.seedlings$treat)] <- 'fertilized'
nat.seedlings$light <- 'control'
nat.seedlings$light[grep('L', nat.seedlings$treat)] <- 'lamps'
nat.seedlings$block <- as.integer((nat.seedlings$plotid - 1)/8) + 1

# column names other than species
non.species.columns <-c('plotid','treat','block','climate','subplot',
                        'grazing','nutrient','light',
                         'month', 'date') 

# all species column names
species.columns <- names(nat.seedlings)[!(names(nat.seedlings) %in% non.species.columns)] 

# long format of data
# also grouping the subplots together here
nat.seedlings.long <- nat.seedlings %>% 
  pivot_longer(cols = species.columns, 
               names_to = 'species', values_to = 'count') %>%
  group_by(plotid, treat, block,climate, grazing, nutrient, light, species, month) %>%
  dplyr::summarise(
    count = sum(count)
  )
#View(nat.seedlings.long)

# summary of total seedling count and species richness in each plot
# split by month
nat.seedlings.plot.sum <- nat.seedlings.long %>% 
  ddply(c('plotid','treat','block','climate','grazing','nutrient','light','month'), 
        summarise,
        total = sum(count),
        richness = sum(count > 0)
  )
nat.seedlings.plot.sum$block <- as_factor(nat.seedlings.plot.sum$block)
nat.seedlings.plot.sum$plotid <- as_factor(nat.seedlings.plot.sum$plotid)
nat.seedlings.plot.sum$month <- as_factor(nat.seedlings.plot.sum$month)

nat.seedlings.plot.sum.2 <- filter(nat.seedlings.plot.sum, 
                                   month %in% c('2019_10','2020_03','2020_05'))
```

## Total seedlings count
Summary for plotting total and richness (code not printed)
```{r summary-plot, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# summarize by month and treatments for plotting
nat.seedlings.summary <- nat.seedlings.plot.sum.2 %>% 
  ddply(c('grazing','nutrient','light','month'),
        summarise, 
        n = length(total),
        total.mean = mean(total),
        total.se = sd(total)/sqrt(n),
        rich.mean = mean(richness),
        rich.se = sd(richness)/sqrt(n))

```

Summary for analyzing total and richness (code not printed)
```{r summary-analysis, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding
# splitting data into just fall or just spring for modeling
nat.seedlings.fall <- nat.seedlings.plot.sum %>% filter(month == '2019_10')
nat.seedlings.spring <- nat.seedlings.plot.sum %>% filter(month == '2020_03')
nat.seedlings.late <- nat.seedlings.plot.sum %>% filter(month == '2020_05')

# combined fall and spring together
nat.seedlings.long.fallspring <- nat.seedlings.long %>%
  filter(month %in% c('2019_10', '2020_03'))
nat.seedlings.plot.both <- nat.seedlings.long.fallspring %>% 
  ddply(c('plotid','treat','block','climate','grazing','nutrient','light'), 
        summarise,
        total = sum(count),
        richness = sum(count > 0)
  )
nat.seedlings.plot.both$block <- as_factor(nat.seedlings.plot.both$block)
nat.seedlings.plot.both$plotid <- as_factor(nat.seedlings.plot.both$plotid)
```


### Total seedling count plot
```{r summary-plot-total, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding}
ggplot(nat.seedlings.summary, aes(x=nutrient, y=total.mean, 
                                  ymin=total.mean-total.se,
                                  ymax=total.mean+total.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Total seedling count') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

#ggsave(filename = 'nat_regen_total_time.pdf', width=6, height=5, units='in')
```

### Total seedling analysis

#### With time
```{r total-seedling-time, echo=FALSE, warning=FALSE, message=FALSE}
model.total <- nat.seedlings.plot.sum %>%
  lmer(total ~ grazing + nutrient + light + month +
         grazing:nutrient + grazing:light + grazing:month +
         nutrient:light + nutrient:month + light:month +
         grazing:nutrient:light + 
         (1|block:plotid),.)
tbl_regression(model.total, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```


Looking at October and March time points as 1. separate models or 2. a combined sum. I think we can make the argument that if we do it this way we won't need time series analyses since we expect Oct seedlings to have died or grown by March, mostly not resampling the same individuals. But there are other approaches to this that use the time series angle.

#### Fall only
```{r tot-seedling-fall, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# want to use block:plot for random effect, but have the error
# number of levels of each grouping factor must be < number of observations
# would need a meta-plot that is the grazing x fert treatment instead
model.total.fall <- nat.seedlings.fall %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.fall, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Spring only
```{r tot-seedling-spring, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.total.spring <- nat.seedlings.spring %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.spring, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Both combined
```{r tot-seedling-both, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.total.both <- nat.seedlings.plot.both %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
tbl_regression(model.total.both, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))

```


## Seedling richness
### Seedling richness plot
```{r summary-plot-richness, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding}
ggplot(nat.seedlings.summary, aes(x=nutrient, y=rich.mean, 
                                  ymin=rich.mean-rich.se, 
                                  ymax=rich.mean+rich.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Seedling richness') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))
#ggsave(filename = 'nat_regen_richness_time.pdf', width=6, height=5, units='in')
```

### Seedling richness analysis
#### With time
```{r rich-seedling-time, echo=FALSE, warning=FALSE, message=FALSE}
model.richness <- nat.seedlings.plot.sum %>%
  lmer(richness ~ grazing + nutrient + light + month +
         grazing:nutrient + grazing:light + grazing:month +
         nutrient:light + nutrient:month + light:month +
         grazing:nutrient:light + 
         (1|block:plotid),.)
tbl_regression(model.richness, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
  'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Fall only
```{r rich-seedling-fall, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

# want to use block:plot for random effect, but have the error
# number of levels of each grouping factor must be < number of observations
# would need a meta-plot that is the grazing x fert treatment instead
model.richness.fall <- nat.seedlings.fall %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.fall, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Spring only
```{r rich-seedling-spring, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.spring <- nat.seedlings.spring %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.spring, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

#### Both combined
```{r rich-seedling-both, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.both <- nat.seedlings.plot.both %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.both, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))

```

#### April/May 
```{r rich-seedling-late, echo=FALSE, warning=FALSE, message=FALSE}
#NOTE: currently doesn't print warnings or messages, take this out while coding

model.richness.late <- nat.seedlings.late %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link="log"))
tbl_regression(model.richness.late, 
               show_single_row = c('grazing','nutrient','light','grazing:nutrient',
                                   'grazing:light','nutrient:light','grazing:nutrient:light'))
```

## Seedling Traits--Biomass data

For the trait analyses we will look at the data sliced a slightly different way--the max number of seedlings per species across the time points (peak emergence for each species)
```{r trait-biomass}

# max across time points (seems to be working, still want to triple-check it)
nat.seedlings.max <- nat.seedlings.long %>%
  group_by(plotid, treat, block, grazing, nutrient, light, species) %>%
  dplyr::summarise(
    count.max = max(count)
  )

# combine with trait data, 
# filter down to the species for which we have trait data
nat.seedlings.traits <- nat.seedlings.max %>% 
  left_join(species.size.6, by = 'species') %>% 
  filter(!is.na(bm.tot))

# summary by species for ggplot
nat.seedlings.traits.sum <- nat.seedlings.traits %>%
  group_by(grazing, nutrient, light, species) %>%
  dplyr::summarise(
    abundance = mean(count.max),
    abundance.se = sd(count.max)/sqrt(10),
    bm.tot = mean(bm.tot), 
    rt.sh.bm = mean(rt.sh.bm),
    len.sh = mean(len.sh)
    # traits should be the same as their values, double-check
  )

```

### Species traits abundance models
The data is overdispersed and/or zero-inflated. We want to try to put together a model format that seems reasonable (perhaps even without the trait data). For this we'll be using the 'glmmTMB' package, which is detailed in "glmmTMB Balances Speed and Flexibility Among Packages for Zero-inflated Generalized Linear Mixed Modeling" by Brooks et al 2017. In this paper, they use the AICtab() function in the 'bblme' package for AIC comparisons of different models. 

Options for model distrubtions are: Poisson, negative binomial, Conway-Maxwell-Poisson, zero-inflated structures for those, and hurdle models. compois doesn't seem to be working at the moment, not sure why; negative binomial is much better than poisson, and minorly underdispersed according to the residuals

```{r basic-models}

# poisson
m.p.basic <- glmmTMB(count.max ~ grazing + nutrient + light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = poisson)

m.p.full <- glmmTMB(count.max ~ grazing * nutrient * light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = poisson)

m.p.specific <- glmmTMB(count.max ~ grazing * nutrient + light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = poisson)

# negative binomial

m.nb.basic <- glmmTMB(count.max ~ grazing + nutrient + light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = nbinom2)

m.nb.full <- glmmTMB(count.max ~ grazing * nutrient * light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = nbinom2)

m.nb.specific <- glmmTMB(count.max ~ grazing * nutrient + light + (1|species) +
                   (1|block:plotid), 
                 nat.seedlings.max, family = nbinom2)


# zi poisson

# zi neg binomial

AICtab(m.p.basic, m.p.full, m.p.specific, 
       m.nb.basic, m.nb.full, m.nb.specific)

E2 <- resid(m.nb.specific, type = "pearson")
N  <- nrow(nat.seedlings.max)
p  <- length(coef(m.nb.specific)) 
sum(E2^2) / (N - p)

```


### Total biomass plot
Preliminary plot of raw data
```{r trait-biomass-plot}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = bm.tot, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Total biomass') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

### Total biomass analysis
Preliminary analysis of total biomass trait using a negative binomial distribution. Also want to consider using a zero-inflated model and comparing using AIC. Right now the result is that having a random effect for species is a better fit than using the total biomass trait, and adding the biomass trait after the species doesn't make much of a difference. Will be interesting to see how this changes with the other traits/the full dataset. 

For the zi setup, could consider doing a random factor for species in the zero-inflation part, and then the trait in the abundance-if-present part? 
```{r trait-biomass-analysis}

m.biomass.0 <- glmmTMB(count.max ~ grazing * nutrient + light +
                         (1|species) + (1|block:plotid),
                       nat.seedlings.traits, family = nbinom2)

m.biomass.1 <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.1b <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                         (1|species) + (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.2 <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                         grazing*nutrient*bm.tot + light*bm.tot +
                         (1|block:plotid),  
                 nat.seedlings.traits, family = nbinom2)

m.biomass.full <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                            grazing*nutrient*bm.tot + light*grazing*bm.tot + 
                            nutrient*light*bm.tot +
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

m.biomass.specific <- glmmTMB(count.max ~ grazing * nutrient + light + bm.tot +
                            light*grazing*bm.tot + 
                         (1|block:plotid), 
                 nat.seedlings.traits, family = nbinom2)

AICtab(m.biomass.0, m.biomass.1, m.biomass.1b, m.biomass.2, m.biomass.full, m.biomass.specific)

E2 <- resid(m.biomass.specific, type = "pearson")
N  <- nrow(nat.seedlings.traits)
p  <- length(coef(m.biomass.specific)) 
sum(E2^2) / (N - p) # somewhat overdispersed
```


### Root-shoot plot
Preliminary plot of raw data
```{r trait-rtsh-plot}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = rt.sh.bm, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Root:shoot ratio (biomass)') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```

### Shoot length plot
Preliminary plot of raw data
```{r trait-length-plot}

## all species with trait data
ggplot(nat.seedlings.traits.sum, aes(x = len.sh, y = abundance, 
                                  ymin = abundance - abundance.se,
                                  ymax = abundance + abundance.se,
                                  color = light)) +
  facet_grid(nutrient~grazing) +
  geom_point(size=1) +
  geom_errorbar(width=0) +
  geom_smooth(method = 'glm', se = FALSE) +
  ylab('Seedling abundance') +
  xlab('Shoot length') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

```


