---
title: "edivalo-seedlings-natural-regen"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup and data structuring
Loads libraries, sets up custom theme for ggplot, and reads in data
```{r setup}
library(plyr)
library(tidyverse)
library(ggplot2)
library(ggthemes)
library(lme4)
library(lmerTest)

# theme for plotting
theme_cw <- function () { 
  theme_bw(base_size=12) %+replace% 
    theme(
      panel.background = element_blank(), 
      plot.background = element_blank(), 
      axis.ticks = element_line(colour = "grey70", size = rel(0.5)),
      panel.grid.minor = element_blank(), 
      panel.grid.major.x = element_blank(),
      legend.background = element_blank(), 
      legend.key = element_blank(),
      strip.background = element_blank(), 
      strip.text=element_text(size=12),
      axis.text=element_text(size=12),
      complete = TRUE
    )
}

# Chhaya's path
nat.seedlings.10 <- read.csv("~/Dropbox/eDiValo-seedlings/Data Entry/natural_regen_2019_10.csv", stringsAsFactors = FALSE)
nat.seedlings.03 <- read.csv("~/Dropbox/eDiValo-seedlings/Data Entry/natural_regen_2020_03.csv", stringsAsFactors = FALSE)
nat.seedlings.05 <- read.csv("~/Dropbox/eDiValo-seedlings/Data Entry/natural_regen_2020_05.csv", stringsAsFactors = FALSE)
nat.seedlings.06 <- read.csv("~/Dropbox/eDiValo-seedlings/Data Entry/natural_regen_2020_06.csv", stringsAsFactors = FALSE)

# Want to combine these together
# remove . and spaces
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.10) <- gsub("[^a-z]","", names(nat.seedlings.10))
names(nat.seedlings.03) <- gsub("[^a-z]","", names(nat.seedlings.03)) 
names(nat.seedlings.05) <- gsub("[^a-z]","", names(nat.seedlings.05))
names(nat.seedlings.06) <- gsub("[^a-z]","", names(nat.seedlings.06))

# small cleaning issues
nat.seedlings.10$subplot <- ifelse(nat.seedlings.10$subplot==1, "O", "I")
nat.seedlings.03$falvul <- as.integer(substr(nat.seedlings.03$falvul, 1, 1))
nat.seedlings.05 <- nat.seedlings.05[,1:43] # removing blank columsn at the end

# add in year_month time point
nat.seedlings.10$month <- '2019_10'
nat.seedlings.03$month <- '2020_03'
nat.seedlings.05$month <- '2020_05'
nat.seedlings.06$month <- '2020_06'

nat.seedlings.a <- full_join(nat.seedlings.10, nat.seedlings.03)
nat.seedlings.b <- full_join(nat.seedlings.05, nat.seedlings.06)
nat.seedlings <- full_join(nat.seedlings.a, nat.seedlings.b)
nat.seedlings <- nat.seedlings %>% select(month, everything()) # move month to the front

# total observations of each
seedling.sums <- colSums(nat.seedlings[7:47], na.rm=TRUE)


# Mia's path

#View(nat.seedlings)
nat.seedlings[is.na(nat.seedlings)] <- 0

# adding separate columns for exclosure, light, and fertilization treatments
nat.seedlings$grazing <- 'sheep'
nat.seedlings$grazing[grep('E', nat.seedlings$treat)] <- 'exclosure'
nat.seedlings$nutrient <- 'unfertilized'
nat.seedlings$nutrient[grep('F', nat.seedlings$treat)] <- 'fertilized'
nat.seedlings$light <- 'control'
nat.seedlings$light[grep('L', nat.seedlings$treat)] <- 'lamps'
nat.seedlings$block <- as.integer((nat.seedlings$plotid - 1)/8) + 1

# column names other than species
non.species.columns <-c('plotid','treat','block','climate','subplot',
                        'grazing','nutrient','light',
                         'month', 'date') 

# all species column names
species.columns <- names(nat.seedlings)[!(names(nat.seedlings) %in% non.species.columns)] 

# long format of data
nat.seedlings.long <- nat.seedlings %>% 
  pivot_longer(cols = species.columns, names_to = 'species', values_to = 'count')
#View(nat.seedlings.long)

# summary of total seedling count and species richness in each plot (combining subplots)
# split by month
nat.seedlings.plot.sum <- nat.seedlings.long %>% 
  ddply(c('plotid','treat','block','climate','grazing','nutrient','light','month'), 
        summarise,
        total = sum(count),
        richness = sum(count > 0)
  )
nat.seedlings.plot.sum$block <- as_factor(nat.seedlings.plot.sum$block)
nat.seedlings.plot.sum$plotid <- as_factor(nat.seedlings.plot.sum$plotid)
```

## Total seedlings and richness summary and plot
Plots of total seedling count and seedling richness
```{r summary-plot}

# just looking at fall and spring (march) since these are
# 1. more abudnant 
# 2. less likely to have repeats (require time series analyses)
nat.seedlings.plot.sum.2 <- nat.seedlings.plot.sum %>%
  filter(month %in% c('2019_10', '2020_03'))

# plot by month and treatments
nat.seedlings.summary <- nat.seedlings.plot.sum.2 %>% 
  ddply(c('grazing','nutrient','light','month'),
        summarise, 
        n = length(total),
        total.mean = mean(total),
        total.se = sd(total)/sqrt(n),
        rich.mean = mean(richness),
        rich.se = sd(richness)/sqrt(n))

ggplot(nat.seedlings.summary, aes(x=nutrient, y=total.mean, 
                                  ymin=total.mean-total.se,
                                  ymax=total.mean+total.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Total seedling count') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))

ggsave(filename = 'nat_regen_total_time.pdf', width=6, height=5, units='in')

ggplot(nat.seedlings.summary, aes(x=nutrient, y=rich.mean, 
                                  ymin=rich.mean-rich.se, 
                                  ymax=rich.mean+rich.se,
                                  color=light)) +
  facet_grid(month~grazing) +
  geom_point(size=2, position=position_dodge(0.2)) +
  geom_errorbar(width=0.2, position=position_dodge(0.2)) +
  ylab('Seedling richness') +
  xlab('') +
  theme_cw() +
  theme(text = element_text(size=12)) +
  scale_color_manual(values=c('black','orange'), name='') +
  theme(legend.position = 'bottom', legend.text=element_text(size=12))
ggsave(filename = 'nat_regen_richness_time.pdf', width=6, height=5, units='in')

```

## Total seedlings and richness analysis

Just looking at October and March time points as separate models. I think we can make the argument that if we do it this way we won't need time series analyses since we expect Oct seedlings to have died or grown by March, mostly not resampling the same individuals. But there are other approaches to this that use the time series angle.

```{r summary-analysis}
nat.seedlings.fall <- nat.seedlings.plot.sum %>% filter(month == '2019_10')
nat.seedlings.spring <- nat.seedlings.plot.sum %>% filter(month == '2020_03')

# want to use block:plot for random effect, but have the error
# number of levels of each grouping factor must be < number of observations
# would need a meta-plot that is the grazing x fert treatment instead
model.total.fall <- nat.seedlings.fall %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
summary(model.total.fall) # 3-way interaction

model.total.spring <- nat.seedlings.spring %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
summary(model.total.spring) 
# 2-way interaction grazing x fertilization, marginal effect of lamps

model.rich.fall <- nat.seedlings.fall %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link = "log"))
summary(model.rich.fall) # sheep x nutrients marginal

model.rich.spring <- nat.seedlings.spring %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link = "log"))
summary(model.rich.spring) # sheep x nutrients, 3-way marginal

```


Another approach would be to lump the fall and spring data for full plot totals
```{r both-seasons}
nat.seedlings.long.fallspring <- nat.seedlings.long %>%
  filter(month %in% c('2019_10', '2020_03'))
nat.seedlings.plot.both <- nat.seedlings.long.fallspring %>% 
  ddply(c('plotid','treat','block','climate','grazing','nutrient','light'), 
        summarise,
        total = sum(count),
        richness = sum(count > 0)
  )
nat.seedlings.plot.both$block <- as_factor(nat.seedlings.plot.both$block)
nat.seedlings.plot.both$plotid <- as_factor(nat.seedlings.plot.both$plotid)

model.total.both <- nat.seedlings.plot.both %>%
  lmer(total ~ grazing * nutrient * light + (1|block),.)
summary(model.total.both) # only sheep x nutrients (3-way interaction marginal)

model.rich.both <- nat.seedlings.plot.both %>%
  glmer(richness ~ grazing * nutrient * light + (1|block),.,
        family = poisson(link = "log"))
summary(model.rich.both) # 3-way interaction

```


